<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Onboarding</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="styles/onboarding.css" />
  </head>
  <body>
    <div class="title">
      <h1>Select At Least 3 Genres</h1>
      <button id="done" class="disabled" disabled>Done</button>
    </div>
    <div class="container">
      <div id="genre-list" class="genre-list"></div>
    </div>

    <script>
      const genreList = []; // Stores selected genres

      // Onboarding completion check
      function checkOnboardingCompletion() {
        fetch("/api/session") // Backend endpoint to check session and onboarding status
          .then((response) => response.json())
          .then((data) => {
            if (data.loggedIn && data.genresCompleted) {
              // Redirect to the homepage if onboarding is already complete
              window.location.href = "/index";
            } else {
              // Allow user to continue with onboarding
              fetchGenres();
              updateButtonState();
            }
          })
          .catch((err) => {
            console.error("Error checking onboarding status:", err);
            alert("An error occurred while checking your session. Please try again.");
          });
      }

      // Update the button state based on the number of selected genres
      function updateButtonState() {
        const doneButton = document.getElementById("done");
        if (genreList.length < 3) {
          doneButton.classList.add("disabled");
          doneButton.disabled = true;
        } else {
          doneButton.classList.remove("disabled");
          doneButton.disabled = false;
        }
      }

      // Fetch genres from AniList API
      function fetchGenres() {
        $.ajax({
          url: "https://graphql.anilist.co",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            query: `
              query {
                GenreCollection
              }
            `,
          }),
          success: function (result) {
            const genres = result.data.GenreCollection;
            const container = document.getElementById("genre-list");
            container.innerHTML = ""; // Clear the genre list container
            genres.forEach((genre) => {
              const genreCard = document.createElement("div");
              genreCard.className = "genre-card";
              genreCard.innerText = genre;

              // Toggle selection on click
              genreCard.onclick = function () {
                genreCard.classList.toggle("selected");
                if (genreList.includes(genre)) {
                  genreList.splice(genreList.indexOf(genre), 1);
                } else {
                  genreList.push(genre);
                }
                updateButtonState();
              };

              container.appendChild(genreCard);
            });
          },
          error: function (error) {
            console.error("Error fetching genres:", error);
          },
        });
      }

      // Handle the "Done" button click
      document.getElementById("done").onclick = function () {
        if (genreList.length >= 3) {
          // Save the selected genres via the backend
          $.ajax({
            url: "/api/save-genres", // Backend endpoint for saving genres
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ genres: genreList }),
            success: function () {
              // Redirect to the home page after successfully saving genres
              window.location.href = "/index";
            },
            error: function (error) {
              console.error("Error saving genres:", error);
              alert("Failed to save genres. Please try again.");
            },
          });
        } else {
          alert("Please select at least three genres.");
        }
      };

      // Run onboarding completion check on page load
      window.onload = checkOnboardingCompletion;
    </script>
  </body>
</html>
